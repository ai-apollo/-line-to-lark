<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINEåŒæ–¹å‘ãƒãƒ£ãƒƒãƒˆç®¡ç†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: #06C755;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    .controls {
      padding: 20px;
      border-bottom: 1px solid #eee;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .button-group {
      display: flex;
      gap: 10px;
    }
    button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-send {
      background: #06C755;
      color: white;
    }
    .btn-send:hover {
      background: #05b34c;
    }
    .btn-load {
      background: #4A90E2;
      color: white;
    }
    .btn-load:hover {
      background: #3a7bc8;
    }
    .chat-container {
      padding: 20px;
      min-height: 400px;
      max-height: 600px;
      overflow-y: auto;
    }
    .message {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }
    .message.incoming {
      justify-content: flex-start;
    }
    .message.outgoing {
      justify-content: flex-end;
    }
    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
    }
    .message.incoming .message-bubble {
      background: #f0f0f0;
      color: #333;
      border-bottom-left-radius: 4px;
    }
    .message.outgoing .message-bubble {
      background: #06C755;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
    }
    .message.system {
      justify-content: center;
    }
    .message.system .message-bubble {
      background: #e8f4fd;
      color: #4A90E2;
      font-size: 12px;
      border-radius: 12px;
    }
    .status {
      padding: 15px 20px;
      background: #f9f9f9;
      border-top: 1px solid #eee;
      font-size: 13px;
      color: #666;
    }
    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .status.error {
      background: #ffebee;
      color: #c62828;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“± LINEåŒæ–¹å‘ãƒãƒ£ãƒƒãƒˆç®¡ç†</h1>
      <p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ & ä¼šè©±å±¥æ­´è¡¨ç¤º</p>
    </div>

    <div class="controls">
      <div class="form-group">
        <label for="userId">LINE User ID</label>
        <input type="text" id="userId" placeholder="ä¾‹: U1234567890abcdef..." />
      </div>

      <div class="form-group">
        <label for="message">é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
        <textarea id="message" placeholder="é€ä¿¡ã—ãŸã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
      </div>

      <div class="button-group">
        <button class="btn-send" onclick="sendMessage()">ğŸ“¤ é€ä¿¡</button>
        <button class="btn-load" onclick="loadHistory()">ğŸ”„ å±¥æ­´ã‚’èª­ã¿è¾¼ã¿</button>
      </div>
    </div>

    <div class="chat-container" id="chatContainer">
      <div class="message system">
        <div class="message-bubble">
          User IDã‚’å…¥åŠ›ã—ã¦ã€Œå±¥æ­´ã‚’èª­ã¿è¾¼ã¿ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
        </div>
      </div>
    </div>

    <div class="status" id="status">æº–å‚™å®Œäº†</div>
  </div>

  <script>
    const API_BASE = window.location.origin;

    function setStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = 'status';
      if (type !== 'info') {
        statusEl.classList.add(type);
      }
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleTimeString('ja-JP', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function addMessageToUI(direction, text, timestamp, eventType = 'message') {
      const container = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${direction === 'system' ? 'system' : direction}`;

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';

      const textDiv = document.createElement('div');
      textDiv.textContent = text;
      bubble.appendChild(textDiv);

      if (timestamp) {
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = formatTime(timestamp);
        bubble.appendChild(timeDiv);
      }

      messageDiv.appendChild(bubble);
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
      const userId = document.getElementById('userId').value.trim();
      const text = document.getElementById('message').value.trim();

      if (!userId || !text) {
        setStatus('âŒ User IDã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      setStatus('ğŸ“¤ é€ä¿¡ä¸­...');

      try {
        const response = await fetch(`${API_BASE}/api/line/send-message`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ userId, text }),
        });

        const result = await response.json();

        if (result.success) {
          setStatus('âœ… é€ä¿¡æˆåŠŸï¼', 'success');
          document.getElementById('message').value = '';

          // UIã«é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
          addMessageToUI('outgoing', text, new Date().toISOString());
        } else {
          setStatus(`âŒ é€ä¿¡å¤±æ•—: ${result.error || result.details}`, 'error');
        }
      } catch (error) {
        setStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }

    async function loadHistory() {
      const userId = document.getElementById('userId').value.trim();

      if (!userId) {
        setStatus('âŒ User IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      setStatus('ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...');

      try {
        const response = await fetch(`${API_BASE}/api/line/get-chat-history?userId=${encodeURIComponent(userId)}`);
        const result = await response.json();

        if (result.success) {
          const container = document.getElementById('chatContainer');
          container.innerHTML = '';

          if (result.history.length === 0) {
            addMessageToUI('system', 'ä¼šè©±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“', null);
          } else {
            result.history.forEach(msg => {
              if (msg.event_type === 'follow') {
                addMessageToUI('system', 'ğŸ‘¤ å‹ã ã¡è¿½åŠ ', msg.timestamp);
              } else if (msg.event_type === 'unfollow') {
                addMessageToUI('system', 'ğŸš« ãƒ–ãƒ­ãƒƒã‚¯', msg.timestamp);
              } else if (msg.message_type === 'text') {
                addMessageToUI(msg.direction, msg.text, msg.timestamp);
              }
            });
          }

          setStatus(`âœ… ${result.count}ä»¶ã®å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
        } else {
          setStatus(`âŒ èª­ã¿è¾¼ã¿å¤±æ•—: ${result.error}`, 'error');
        }
      } catch (error) {
        setStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }

    // Enterã‚­ãƒ¼ã§é€ä¿¡
    document.getElementById('message').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
