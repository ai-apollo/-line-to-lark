<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‹ã ã¡è¿½åŠ  - LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #06C755 0%, #00B900 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px 30px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      text-align: center;
    }
    .logo {
      font-size: 60px;
      margin-bottom: 20px;
    }
    h1 {
      font-size: 24px;
      color: #333;
      margin-bottom: 10px;
    }
    .source-tag {
      display: inline-block;
      background: #e8f5e9;
      color: #2e7d32;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    .message {
      color: #666;
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 30px;
    }
    .button {
      display: block;
      width: 100%;
      padding: 16px;
      background: #06C755;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
      margin-bottom: 12px;
    }
    .button:hover {
      background: #05b34c;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(6, 199, 85, 0.3);
    }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .status {
      font-size: 13px;
      color: #999;
      margin-top: 20px;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #06C755;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .success {
      color: #2e7d32;
      font-weight: 600;
    }
    .error {
      color: #c62828;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ğŸ’š</div>
    <h1>LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h1>
    <div class="source-tag" id="sourceTag">ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹</div>
    <p class="message">
      å‹ã ã¡è¿½åŠ ã—ã¦ã„ãŸã ãã¨ã€<br>
      ãŠå¾—ãªæƒ…å ±ã‚„ã‚µãƒãƒ¼ãƒˆã‚’ãŠå±Šã‘ã—ã¾ã™ï¼
    </p>
    <button class="button" id="addFriendBtn" disabled>
      <span class="loading"></span>
      èª­ã¿è¾¼ã¿ä¸­...
    </button>
    <div class="status" id="status">LINEã«æ¥ç¶šä¸­...</div>
  </div>

  <script>
    const SOURCE_LABELS = {
      'note': 'ğŸ“ noteçµŒç”±',
      'X': 'ğŸ¦ Xï¼ˆTwitterï¼‰çµŒç”±',
      'LP': 'ğŸŒ ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸çµŒç”±',
      'ads': 'ğŸ“¢ åºƒå‘ŠçµŒç”±',
      'direct': 'ğŸ”— ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹',
    };

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰sourceã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const source = urlParams.get('source') || 'direct';
    const sourceLabel = SOURCE_LABELS[source] || SOURCE_LABELS['direct'];

    document.getElementById('sourceTag').textContent = sourceLabel;

    async function trackUser(userId, displayName, pictureUrl) {
      try {
        const response = await fetch('/api/line/track', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId,
            displayName,
            pictureUrl,
            source,
          }),
        });

        const result = await response.json();
        console.log('âœ… Tracking result:', result);
        return result.success;
      } catch (error) {
        console.error('âŒ Tracking error:', error);
        return false;
      }
    }

    async function initLiff() {
      const statusEl = document.getElementById('status');
      const btnEl = document.getElementById('addFriendBtn');

      try {
        // LIFFåˆæœŸåŒ–
        await liff.init({ liffId: '2008252843-G6k1DX03' });

        if (!liff.isLoggedIn()) {
          // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
          liff.login();
          return;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
        const profile = await liff.getProfile();
        console.log('ğŸ‘¤ User profile:', profile);

        // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°é€ä¿¡
        statusEl.innerHTML = 'ğŸ“Š ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨˜éŒ²ä¸­...';
        const tracked = await trackUser(profile.userId, profile.displayName, profile.pictureUrl);

        if (tracked) {
          statusEl.innerHTML = '<span class="success">âœ… è¨˜éŒ²å®Œäº†</span>';
        } else {
          statusEl.innerHTML = '<span class="error">âš ï¸ è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸãŒç¶šè¡Œã§ãã¾ã™</span>';
        }

        // å‹é”è¿½åŠ çŠ¶æ…‹ã‚’ç¢ºèª
        const friendship = await liff.getFriendship();

        if (friendship.friendFlag) {
          // æ—¢ã«å‹é”
          btnEl.textContent = 'âœ… å‹ã ã¡è¿½åŠ æ¸ˆã¿';
          btnEl.disabled = true;
          statusEl.innerHTML = '<span class="success">âœ… æ—¢ã«å‹ã ã¡è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™</span>';
        } else {
          // æœªè¿½åŠ ã®å ´åˆ
          btnEl.textContent = 'å‹ã ã¡è¿½åŠ ã™ã‚‹';
          btnEl.disabled = false;
          btnEl.onclick = () => {
            // LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            window.location.href = 'https://line.me/R/ti/p/@ã‚ãªãŸã®LINE_ID';
          };
        }

      } catch (error) {
        console.error('âŒ LIFF Error:', error);
        statusEl.innerHTML = '<span class="error">âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>';
        btnEl.textContent = 'å†èª­ã¿è¾¼ã¿';
        btnEl.disabled = false;
        btnEl.onclick = () => location.reload();
      }
    }

    // LIFFåˆæœŸåŒ–
    initLiff();
  </script>
</body>
</html>
